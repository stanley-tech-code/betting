<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>üöÄ Traffic Command Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap"
    rel="stylesheet">
  <style>
    /* CSS Variables */
    :root {
      --bg-color: #050a14;
      --card-bg: rgba(16, 24, 40, 0.7);
      --accent-cyan: #00f3ff;
      --accent-purple: #bc13fe;
      --accent-red: #ff0055;
      --text-primary: #e2e8f0;
      --border-color: rgba(255, 255, 255, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      background-image:
        radial-gradient(circle at 10% 20%, rgba(188, 19, 254, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(0, 243, 255, 0.1) 0%, transparent 20%);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 30px 20px;
    }

    h1 {
      font-family: 'Orbitron', sans-serif;
      text-align: center;
      font-size: 2.2rem;
      margin-bottom: 30px;
      background: linear-gradient(to right, var(--accent-cyan), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      gap: 30px;
    }

    /* Cards */
    .dashboard-card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
    }

    h2 {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.2rem;
      color: var(--accent-cyan);
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    th {
      text-align: left;
      padding: 12px;
      color: var(--text-secondary);
      font-size: 0.85rem;
      text-transform: uppercase;
    }

    td {
      padding: 12px;
      border-top: 1px solid var(--border-color);
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.03);
    }

    .landing-id {
      font-family: 'Orbitron', sans-serif;
      color: #fff;
    }

    .metric-value {
      font-weight: 600;
    }

    .leads-highlight {
      color: var(--accent-purple);
      text-shadow: 0 0 8px rgba(188, 19, 254, 0.4);
    }

    .phone-number {
      font-family: 'Orbitron', sans-serif;
      color: var(--accent-cyan);
      letter-spacing: 1px;
    }

    .time-ago {
      font-size: 0.85rem;
      color: #94a3b8;
    }
  </style>
</head>

<body>

  <div class="container">
    <h1>Traffic Command Center</h1>

    <!-- Stats Overview -->
    <!-- Stats Overview -->
    <div class="dashboard-card" style="border-color:var(--accent-cyan);">
      <h2>üìä Performance Overview</h2>
      <table>
        <thead>
          <tr>
            <th>Landing Page</th>
            <th>Visits</th>
            <th>Clicks</th>
            <th>Leads</th>
            <th>CTR</th>
          </tr>
        </thead>
        <tbody id="statsBody"></tbody>
      </table>
    </div>

    <!-- VARIANT PERFORMANCE ENGINE (STEP 7.4) -->
    <div class="dashboard-card" style="border-color:var(--accent-purple);">
      <h2>üß¨ AI Variant Performance Engine</h2>
      <div style="margin-bottom:15px; display:flex; gap:10px;">
        <button onclick="proposeVariant()"
          style="background:var(--accent-purple); color:#fff; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; font-weight:bold;">‚ú®
          ASK AI TO GENERATE VARIANT</button>
        <span id="genStatus" style="color:#aaa; font-size:0.85rem; padding-top:5px;"></span>
      </div>

      <!-- Variants Grid -->
      <div id="variantsGrid"
        style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px;">
        <!-- Loading Variants... -->
      </div>
    </div>

    <!-- Live Leads Feed -->
    <div class="dashboard-card">
      <h2>
        üî• Live Leads Feed
        <span style="font-size:0.8rem; float:right; margin-left:10px;">
          <a href="/api/stats/download-leads"
            style="color:var(--accent-cyan); text-decoration:none; border:1px solid var(--accent-cyan); padding:5px 10px; border-radius:5px;">‚¨á
            Download All CSV</a>
        </span>
        <span style="font-size:0.8rem; float:right; color:#fff;">Last 50</span>
      </h2>
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Phone Number</th>
            <th>Source Page</th>
          </tr>
        </thead>
        <tbody id="leadsBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API = "/api/stats/dashboard-summary";
    const fmt = (n) => new Intl.NumberFormat().format(n);

    async function loadDashboard() {
      try {
        const res = await fetch(API);
        const data = await res.json();

        // Update Stats
        const statsBody = document.getElementById("statsBody");
        let statsHtml = "";
        if (data.stats && Object.keys(data.stats).length > 0) {
          Object.keys(data.stats).forEach(landing => {
            const s = data.stats[landing];
            statsHtml += `<tr>
              <td class="landing-id">${landing}</td>
              <td class="metric-value">${fmt(s.visits)}</td>
              <td class="metric-value">${fmt(s.clicks)}</td>
              <td class="metric-value leads-highlight">${fmt(s.leads)}</td>
              <td class="metric-value" style="color: ${s.ctr > 10 ? '#4ade80' : '#fff'}">${s.ctr}%</td>
            </tr>`;
          });
        } else {
          statsHtml = "<tr><td colspan='5' style='text-align:center; padding:20px; color:#666;'>No Data Yet</td></tr>";
        }
        statsBody.innerHTML = statsHtml;

        // Update Leads
        const leadsBody = document.getElementById("leadsBody");
        let leadsHtml = "";
        if (data.recentLeads && data.recentLeads.length > 0) {
          data.recentLeads.forEach(lead => {
            const date = new Date(lead.created_at);
            const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            leadsHtml += `<tr>
                  <td class="time-ago">${timeStr}</td>
                  <td class="phone-number">${lead.phone}</td>
                  <td>${lead.landing_id || '-'}</td>
              </tr>`;
          });
        } else {
          leadsHtml = "<tr><td colspan='3' style='text-align:center; padding:20px; color:#666;'>Waiting for leads...</td></tr>";
        }
        leadsBody.innerHTML = leadsHtml;

      } catch (e) {
        console.error("Dashboard error", e);
      }
    }

    loadDashboard();
    loadDashboard();
    setInterval(loadDashboard, 5000);

    // --- VARIANT ENGINE LOGIC ---
    async function loadVariants() {
      try {
        // 1. Load Analysis (Performance Score)
        const res = await fetch('/api/variant/analyze');
        const data = await res.json();

        // 2. Load Pending List (for approvals)
        const pendingRes = await fetch('/api/variant/list');
        const pendingData = await pendingRes.json();

        const grid = document.getElementById("variantsGrid");
        grid.innerHTML = "";

        // MERGE Logic: Display Analyzed variants + Pending variants
        const allVariants = [];

        // Add Pending first
        if (pendingData.variants) {
          pendingData.variants.filter(v => v.status === 'PENDING').forEach(v => {
            allVariants.push({
              ...v,
              type: 'PENDING',
              score: '?',
              insight: 'Waiting for approval to start testing.'
            });
          });
        }

        // Add Analyzed (Approved/Live)
        if (data.stats) {
          data.stats.forEach(s => {
            allVariants.push({ ...s, type: 'LIVE' });
          });
        }

        if (allVariants.length === 0) {
          grid.innerHTML = `<div style="color:#666; font-style:italic;">No variants active. Ask AI to generate one.</div>`;
          return;
        }

        allVariants.forEach(v => {
          let statusColor = "#777";
          let actions = "";
          let badge = "";

          if (v.type === 'PENDING') {
            statusColor = "#facc15";
            badge = `<span style="background:${statusColor}; color:#000; padding:2px 6px; border-radius:4px; font-size:0.7rem; font-weight:bold;">PENDING APPROVAL</span>`;
            actions = `
                        <div style="margin-top:10px; display:flex; gap:10px;">
                            <button onclick="updateVariantStatus('${v.id}', 'APPROVED')" style="background:#22c55e; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">‚úÖ APPROVE</button>
                            <button onclick="updateVariantStatus('${v.id}', 'REJECTED')" style="border:1px solid #ef4444; color:#ef4444; background:transparent; padding:6px 12px; border-radius:4px; cursor:pointer;">‚ùå REJECT</button>
                        </div>
                    `;
          } else {
            // LIVE VARIANT
            if (v.status === 'SCALE') statusColor = "#22c55e";
            if (v.status === 'PAUSE') statusColor = "#ef4444";
            if (v.status === 'TEST MORE') statusColor = "#38bdf8";

            badge = `<span style="background:${statusColor}; color:#fff; padding:2px 6px; border-radius:4px; font-size:0.7rem; font-weight:bold;">${v.status}</span>`;
            actions = `
                         <div style="margin-top:10px; padding-top:10px; border-top:1px solid #333; font-size:0.85rem;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <span>CTR: <b>${v.ctr}%</b></span>
                                <span>Leads: <b>${v.leadRate}%</b></span>
                            </div>
                            <div style="color:${statusColor}; font-weight:bold;">Score: ${v.score}/100</div>
                            <div style="font-size:0.8rem; color:#aaa; margin-top:5px;">AI: "${v.insight}"</div>
                            <div style="margin-top:5px; font-size:0.75rem;"><a href="/index.html?v=${v.id}" target="_blank" style="color:#fff;">View Live Page</a></div>
                        </div>
                    `;
          }

          grid.innerHTML += `
                    <div style="background:rgba(0,0,0,0.3); border:1px solid ${statusColor}; border-radius:12px; padding:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                            <h3 style="margin:0; font-size:1rem; color:#fff;">${v.name || v.variant_name}</h3>
                            ${badge}
                        </div>
                        <div style="color:#ccc; font-style:italic; font-size:0.9rem; margin-bottom:10px;">"${v.headline}"</div>
                        ${actions}
                    </div>
                `;
        });

      } catch (e) { console.error(e); }
    }

    async function proposeVariant() {
      const btn = document.querySelector('button[onclick="proposeVariant()"]');
      btn.disabled = true;
      document.getElementById("genStatus").innerText = " AI Generating...";

      await fetch('/api/variant/propose', { method: 'POST' });

      document.getElementById("genStatus").innerText = " Done!";
      btn.disabled = false;
      loadVariants();
    }

    async function applyAI() {
      if (!confirm("‚ö†Ô∏è AUTOMATION SAFETY CHECK\n\nThis will update your live traffic routing based on AI scores.\n\n- Winners will get ~80% traffic\n- Testers will get ~20%\n- Losers will be paused\n\nProceed?")) return;

      const btn = document.querySelector('button[onclick="applyAI()"]');
      btn.disabled = true;
      btn.innerText = "‚è≥ OPTIMIZING...";

      try {
        const res = await fetch('/api/variant/apply-weights', { method: 'POST' });
        const data = await res.json();
        alert("‚úÖ AI Optimization Complete.\n\n- Updated variants: " + data.updates.length);
        loadVariants(); // Reload to see changes
      } catch (e) {
        alert("Error applying weights.");
        console.error(e);
      }

      btn.disabled = false;
      btn.innerHTML = "<span>‚ö° APPLY AI RECOMMENDATIONS</span>";
    }

    async function updateVariantStatus(id, status) {
      await fetch('/api/variant/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, status })
      });
      loadVariants();
    }

    loadVariants();
    setInterval(loadVariants, 10000);

    // --- WATCHDOG LOGIC ---
    async function pollWatchdog() {
      try {
        const res = await fetch('/api/traffic/monitor'); // Trigger the check
        const data = await res.json();

        const logsDiv = document.getElementById("logsFeed");

        if (data.logs && data.logs.length > 0) {
          logsDiv.innerHTML = "";
          data.logs.forEach(log => {
            const time = new Date(log.created_at).toLocaleTimeString();
            let color = "#fff";
            if (log.event_type === "ROLLBACK") color = "#ef4444";

            logsDiv.innerHTML += `
                        <div style="padding:5px 0; border-bottom:1px solid #333;">
                            <span style="color:#777;">[${time}]</span> 
                            <b style="color:${color}">${log.event_type}</b>: ${log.message}
                        </div>
                    `;
          });
        } else {
          logsDiv.innerHTML = `<div style="padding:5px 0; color:#4ade80;">[SYSTEM] All systems nominal. No incidents reported.</div>`;
        }

      } catch (e) { console.error("Watchdog error", e); }
    }

    pollWatchdog();
    setInterval(pollWatchdog, 15000); // Check every 15s

  </script>

</body>

</html>